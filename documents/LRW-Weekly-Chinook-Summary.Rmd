---
# title: "Lostine River Weir Weekly Chinook Summary"
#author: "Tyler Stright"
#date: '`r format(Sys.time(), "%d %B, %Y")`'
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
output: pdf_document
---
```{r Loadout, include=FALSE}
# Load Packages ----
# devtools::install_github("DesiQuintans/librarian") # if you need librarian package

librarian::shelf(knitr,
                 flextable,
                 ryankinzer/cdmsR,
                 ryankinzer/cuyem,
                 tidyverse)

source('../R/01_cdms_api_keys.R')
source('../R/02_sumGRSMEdisp.R') # FINS Disposition Summary
source('../R/03_sumGRSMEbrood.R') # Brood Collection Summary

# set values
trap.year <- year(Sys.time())  

# A better way to get GRSME data from TY 2022-02-10
# GRSME_data <- get_WeirData(Facility = 'NPT GRSME Program')

# Data Download logic
download_FINS_CDMS <- FALSE # TRUE = download and save new FINS data from CDMS; FALSE = use existing AdultWeirData.rda
# grsme_data <- 'kus'
grsme_data <- 'fins'#Choose 'fins' or 'kus', download and save data appropriately
files <- list.files(path = '../data/')
```

```{r Estimates and Goals, include = FALSE}
# Season Return Estimates 
estimate_date <- "June 21, 2023"  # format: "June 15th"
nat_adults <- "262"
hat_adults <- "544"

# Brood Stock Collection Goals
N_brood_goal <- "48" # natural-origin adults
H_brood_goal <- "112" # hatchery-origin adults
HJ_brood_goal <- "6" # hatchery-origin jacks #always 6

# Sliding Scale Goals
SS_upstream <- "50%" # % hatchery passed upstream
SS_brood <- "30%"  # % natural kept for brood
```

```{r cdms-login, eval = TRUE, message = FALSE, include=FALSE}
 # cdms_host <- 'https://npt-cdms.nezperce.org'# REMOVE?
 # api_key = 'api_user'# why are you using this to set a value for just below?
 # cdmsR::cdmsLogin('api_user', api_key, cdms_host = cdms_host)# Generic Login 

 cdmsR::cdmsLogin('api_user', 'api_user')
 
```

```{r Get Data, include = FALSE}
# Adult Weir (FINS) data ----
if(download_FINS_CDMS == TRUE) {
  # Download fins data.
  AdultWeirData <- get_WeirData(Facility  = 'NPT GRSME Program') #Why am i not just pulling NPT GRSME Program facility data here?
  # Save to the data folder as an R data file
  save(AdultWeirData, file = '../data/AdultWeirData.rda')
  
    # Clean weir data
  AdultWeirData_clean <- clean_weirData(AdultWeirData) %>%
    mutate(MonthDay = format(as.Date(trapped_date), '%m/%d')) 
  
  GRSME_df <- AdultWeirData_clean  %>%
    filter(facility == 'NPT GRSME Program') # I should be able to remove this step or check to make sure it matches the data I'm getting from get_WeirData(Facility = 'NPT GRSME Program')
} else {
  load(file = '../data/AdultWeirData.rda')
    # Clean weir data
  AdultWeirData_clean <- clean_weirData(AdultWeirData) %>%
    mutate(MonthDay = format(as.Date(trapped_date), '%m/%d')) 
}

if(grsme_data == 'kus'){ # if using Kus-downloaded data
  GRSME_df <- read_csv(paste0('../data/FINS_trapping_NPT_GRSME_Program_', max(str_extract(files[which(grepl('FINS_trapping_NPT_GRSME_Program', list.files('../data/')))], '\\d{4}[-]\\d{2}[-]\\d{2}')), '.csv')) %>%
    mutate(trapped_date = mdy(trapped_date), # make sure trapped_date is a date datatype
           MonthDay = format(as.Date(trapped_date), '%m/%d')) # so this can work properly.
}

if(grsme_data == 'fins'){ # if using FINS-downloaded data
  GRSME_df <- read_csv('../data/TrappingData.csv') %>%

    # I need to fix the code below if I want a dynamic import and to save FINs files with a date appended to the end. Otherwise the code above is sufficient.
    
    # GRSME_df <- read_csv(paste0('./data/TrappingData_Fins_', max(str_extract(files[which(grepl('TrappingData_Fins_', list.files('./data/')))], '\\d{6}')), '.csv')) %>%

  clean_weirData() %>%
mutate(trapped_date = ymd(trapped_date), # make sure trapped_date is a date datatype
MonthDay = format(as.Date(trapped_date), '%m/%d')) # so this can work properly.
}
```

```{r Data Processing: Dispositions, include=FALSE}
# Hatchery Dispositions
h_df <- sumGRSMEdisp(data = GRSME_df, origin_ ='Hatchery', trap.year = trap.year)

# Natural Dispositions
n_df <- sumGRSMEdisp(data = GRSME_df, origin_ ='Natural', trap.year = trap.year)

# Composition Percentages
hat_up <- as.numeric(str_extract(h_df[[1,5]], '^[:digit:]*')) # upstream
nat_up <- as.numeric(str_extract(n_df[[1,5]], '^[:digit:]*')) # upstream
  H_upstream_calc <- round((hat_up/(hat_up+nat_up))*100, 0)

hat_BS <- as.numeric(str_extract(h_df[[2,5]], '^[:digit:]*')) # broodstock
nat_BS <- as.numeric(str_extract(n_df[[2,5]], '^[:digit:]*')) # broodstock
  N_brood_calc <- round((nat_BS/(hat_BS+nat_BS))*100, 0)

```


```{r Plot Prep: Catch + Flow, include = FALSE}
# Flow Data ----
start_date <- paste0(trap.year, '-05-30')
end_date <- paste0(trap.year, '-09-30')

req_url <- paste("https://apps.wrd.state.or.us/apps/sw/hydro_near_real_time/hydro_download.aspx?station_nbr=13330000&start_date=",
                 start_date, # start date
                 "%2012:00:00%20AM&end_date=",
                 end_date, #Sys.Date(), # end date
                 "%2012:00:00%20AM&dataset=MDF&format=csv",  # output: CSV
                 sep='')

flow_df <- read.delim(req_url, sep = '\t') %>%
  mutate(record_date = mdy(record_date),
         legend = paste(Sys.Date()-1, 'Discharge'),
         MonthDay = format(as.Date(record_date), '%m/%d'),
         facet = paste(trap.year)) %>%
  select(MonthDay, MeanDailyFlow = mean_daily_flow_cfs, facet) 

start_date_H <- paste0(trap.year-5, '-05-30')
end_date_H <- paste0(trap.year-1, '-09-21')

req_url2 <- paste("https://apps.wrd.state.or.us/apps/sw/hydro_near_real_time/hydro_download.aspx?station_nbr=13330000&start_date=",
                  start_date_H, # start date
                  "%2012:00:00%20AM&end_date=",
                  end_date_H, # end date
                  "%2012:00:00%20AM&dataset=MDF&format=csv",  # output: CSV
                  sep='')

flow_df_H <- read.delim(req_url2, sep = '\t') %>%
  mutate(record_date = mdy(record_date),
         legend = paste(Sys.Date()-1, 'Discharge'),
         MonthDay = format(as.Date(record_date), '%m/%d')) %>%
  group_by(MonthDay) %>%
  summarize(MeanDailyFlow = mean(mean_daily_flow_cfs)) %>%
  mutate(facet = paste(trap.year-5, '-', trap.year-1, " Average", sep=''))

flow_all <- bind_rows(flow_df, flow_df_H) %>%
  mutate(trapped_date = paste(trap.year, '/', as.character(MonthDay), sep = ''),
         trapped_date = ymd(trapped_date)) %>% # trapped date cheat.
  filter(between(trapped_date, ymd(paste0(trap.year, '-05-30')), ymd(paste0(trap.year, '-09-21'))))

# Current year's catch ----

# glimpse(GRSME_df)
# unique(GRSME_df$species)
# unique(GRSME_df$recap)
# unique(GRSME_df$trap_year)
# unique(GRSME_df$age_designation)

LRW_catch <- GRSME_df %>%
  filter(species == 'Chinook',
         recap == FALSE,
         trap_year == trap.year,
         age_designation == 'Adult') %>%
  group_by(trapped_date, MonthDay, origin) %>%
  summarize(Catch = sum(count, na.rm = TRUE)) %>%
  mutate(facet = paste(trap.year))

# Historic Catch ----
LRW_historic <- AdultWeirData_clean %>%
  filter(facility == 'NPT GRSME Program', 
         species == 'Chinook',
         recap == FALSE,
         !trap_year %in% c(1997:(trap.year-6), trap.year),
         age_designation == 'Adult') %>%
  group_by(MonthDay, origin) %>%  # get the total catch for Month/Day
  summarize(AllCatch = sum(count, na.rm = TRUE)) %>%
  mutate(Catch = AllCatch/5) %>% # calculate Mean Daily Catch: AllCatch from years, divided by number of years (5)
  mutate(trapped_date = ymd(paste(trap.year, '-', MonthDay)),
         facet = paste(trap.year-5, '-', trap.year-1, " Average", sep=''))

LRW_all <- bind_rows(LRW_catch, LRW_historic)



# MEGA DF!
LRW_megadf <- full_join(LRW_all, flow_all, by = c('trapped_date', 'facet', 'MonthDay'))

LRW_megadf$facet <- factor(LRW_megadf$facet, levels = c(trap.year, paste0(trap.year-5, '-', trap.year-1, ' Average')))
     # this above allows me to order the facet_grid properly with 2020 on top.
```  


```{r Graph Creation, include = FALSE}  
# get Plot Max value for Y axis
plot_max_df <- LRW_catch %>%
  group_by(trapped_date) %>%
  summarize(Count = sum(Catch)) 

plot_max <- max(plot_max_df$Count)+2


# Calculate scale factor (for dual Y axes)
scaleFactor <- round(max(LRW_megadf$Catch, na.rm=TRUE)/max(LRW_megadf$MeanDailyFlow, na.rm=TRUE), 3)

# Plot
lrw_megaplot <- ggplot(LRW_megadf, aes(x=trapped_date)) +
  # Data
  geom_bar(data = LRW_megadf, aes(x = trapped_date, y = Catch, fill = origin), color = 'black',
           stat='identity', position = 'stack', width = 1) +
  geom_line(data = LRW_megadf, 
            aes(x = trapped_date, y = MeanDailyFlow*scaleFactor, linetype= "Discharge"), 
            color = 'blue', size = 1) +
  # Y axis
  scale_y_continuous(name = 'Number of Chinook Adults', 
                     breaks = scales::breaks_pretty(7), 
                     limits = c(0, max(0, plot_max)),
                     expand = c(0, 0), sec.axis=sec_axis(~./scaleFactor, 
                     name = expression(paste("Discharge ("*ft^3*"/s)", sep='')), 
                     breaks = scales::breaks_pretty(7))) +
  # X Axis
  scale_x_date(name = '', labels = scales::label_date("%m/%d"), 
               breaks = scales::breaks_pretty(7), 
               expand = c(.001, .001)) +
  # Theme
  theme_bw() +
  theme(
    axis.text.x = element_text(hjust = 1, angle = 45, size = 14),
    axis.ticks.length.x = unit(.15, "cm"),
    axis.title.y.left=element_text(size = 16),
    axis.text.y.left=element_text(size = 14),
    axis.title.y.right=element_text(color="blue", size = 16),
    axis.text.y.right=element_text(color="blue", size = 14),
    # panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = 'top',
    legend.title = element_blank(), 
    legend.box.background = element_blank(), # element_rect(colour = "black")
    panel.spacing = unit(2, 'lines')
  ) + 
  guides(color = FALSE) +
  scale_fill_manual(values =c("Natural"='#FDE735FF', "Hatchery" = '#482677FF')) +
  facet_grid(rows=vars(facet))

ggsave(filename = 'LRW_megaplot.jpg', 
       device='jpeg',
       path = './',
       height = 7, 
       width = 10, 
       units = "in")

lrw_megaplot
```

```{r Data Processing: Broodstock Collection, include=FALSE}
table_3 <- sumGRSMEbrood(data = GRSME_df, trap.year = trap.year)
```

```{r header_image, out.width= "450px", fig.align='center', echo=FALSE}
include_graphics(path = '../www/npt_joseph.png')
```

\begin{center}
{\Large Lostine River Weir\par}
{\large Weekly Chinook Summary: `r format(Sys.time(), '%B %d, %Y')`}
\end{center}


Disposition Summary

+ In-season adult return-to-tributary estimates were updated on `r estimate_date` to `r nat_adults` natural-origin and `r hat_adults` hatchery-origin adults. \newline 
+ Brood stock collection goals are `r N_brood_goal` natural-origin adults, `r H_brood_goal` hatchery-origin adults, and `r HJ_brood_goal` hatchery-origin jacks. \newline 
+ Composition of adults passed upstream: `r H_upstream_calc`% Hatchery (Sliding scale goal $\leq$ `r SS_upstream`) \newline
+ Composition of adults kept for brood: `r N_brood_calc`% Natural (Sliding scale goal $\geq$ `r SS_brood`) \newline

```{r Table1_Hatchery_Dispositions, echo=FALSE, fig.align='center', warning=FALSE}
flex_h <- flextable(h_df,
          cwidth = c(1.3,0.7,0.7,0.7,1.2,1.2)) %>%
  align(j=2:6, align = 'right', part = 'all') %>%
  hline(i=nrow(h_df)-1) %>%
  set_caption(caption = paste0('Return year ',trap.year,' capture and disposition summary of Hatchery Chinook Salmon (Numbers in parentheses exclude recaptures).'))

knit_print(flex_h)
```

\newpage

```{r Table2_Natural_Dispositions, echo=FALSE, fig.align='center', warning=FALSE}
flex_n <- flextable(n_df,
          cwidth = c(1.3,0.7,0.7,0.7,1.2,1.2)) %>%
  align(j=2:6, align = 'right', part = 'all') %>%
  hline(i=nrow(n_df)-1) %>%
  set_caption(caption = paste0('Return year ',trap.year,' capture and disposition summary of Natural Chinook Salmon (Numbers in parentheses exclude recaptures).'))

knit_print(flex_n)
```

```{r Table3_Broodstock, echo=FALSE, fig.align='center', warning=FALSE}
flex_bt <-  flextable(table_3,
          cwidth = c(1,1.5,1.5,1.2)) %>%
  align(j=2:4, align = 'right', part = 'all') %>%
  hline(i=nrow(table_3)-1) %>%
  set_caption(caption = paste0('Return year ',trap.year,' weekly summary of captured adult Chinook Salmon and Bull Trout, excluding recaptures.  Broodstock collection for Chinook Salmon is shown in parenthesis. *Asterisk indicates an incomplete week.'))

knit_print(flex_bt)

# flex_bt
```


\newpage

\blandscape


![Return year `r trap.year` (top panel) and five-year average (bottom panel) of mean daily discharge (cubic feet per second) and daily captures of hatchery- and natural-origin adult Chinook salmon at the Lostine River Weir. Discharge recorded at USGS station 1333000 located upstream of the town of Lostine.](LRW_megaplot.jpg)


\elandscape

\newpage


\center{\underline{\textbf{Distribution List}}}

\begin{minipage}[t]{0.25\textwidth}
\end{minipage}
\begin{minipage}[t]{0.5\textwidth}
Beals, S (ODFW)\\
Brady, A (BPA)\\
Brandt, E (ODFW)\\
Bratcher, K (ODFW)\\
Brigante, E (ODFW)\\
Bronson, P (CTUIR)\\
Bonifer, J (CTUIR)\\
Craft, N (ODFW)\\
Deal, D (ODFW)\\
Engle, R (FWS)\\
Farnam, B (NOAA)\\ 
Feldhaus, J (ODFW)\\
Garza, Gabriel (ODFW)\\  
Gee, S (ODFW)\\
Gibbs, A (ODFW)\\
Greiner, M (ODFW)\\
Hagenah, P (Landowner)\\
Harbeck, J (NPT)\\
Harrod, R (ODFW)\\ 
Hesse, J (NPT)\\
Humphreys, J (TU)\\
Johnson, B (NPT)\\
\end{minipage}
\begin{minipage}[t]{0.25\textwidth}
Johnson, D (NPT)\\
Kozlowski, C (ODFW)\\
Lance, M (ODFW)\\
Lemanski, J (ODFW)\\
Maxwell, A (TU)\\
McLean, M (CTUIR)\\
Nisbitt, K (Wallowa CTY)\\
Oatman, J (NPT)\\
Robertson, M (FWS)\\
Rumelhart, R (NPT)\\
Ruzycki, J (ODFW)\\
Treadway, E (ODFW)\\
Smith, J (ODFW)\\
Vatland, S (NPT)\\
Vogel, J (NPT)\\
Watry, C (NPT)\\
Wiese, N (USFWS)\\ 
Wolfe, W (Landowner)\\
Yanke, J (ODFW)\\
Yearout, J (NPT)\\
Young, B (NPT)\\
Zollman, R (NPT)\\
\end{minipage}

***

\begin{center}
\bf{Please direct questions regarding content of this report to:}
\end{center}

\begin{center}
{\large Brian Simmons \\}
Grande Ronde Supplemenetation Monitoring and Evalutation\\
Fisheries Biologist II\\
541-432-2515\\
brians@nezperce.org \par 

or\par 

{\large Shane Vatland \\}
Grand Ronde Supplementation Monitoring and Evaluation\\
Project Leader\\
541-432-2508\\
shanev@nezperce.org\vspace{5mm} 

{\large Nez Perce Tribe\\}
Joseph Field Office\\
500 North Main Street\\
P.O.Box 909\\
Joseph, OR 97846
\end{center}

